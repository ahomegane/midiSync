<!DOCTYPE HTML>
<html>
<head>
  <meta charset="UTF-8">
  <title>node.js chat</title>  
  <style>
    *{
      margin:0;
      padding:0;
    }
  </style>
</head>
<body>
  <div id="msg_list" style="height:300px; overflow:auto;"></div>
  <form action="" method="post" onsubmit="return false;">
    <input type="text" class="text" style="width:95%; padding:10px" id="message"/>
    <input type="submit" class="button" style="padding:10px" onclick="sendMessage();" value="みんなに送信" />
    <input type="submit" class="button" style="padding:10px" onclick="sendBroadcast();" value="自分以外に送信" />
  </form>

  <div id="info"></div>

  <h2>midi_in</h2>
  <select id="midi_in">
    <option>選択してください</option>
  </select>

  <h2>midi_out</h2>
  <select id="midi_out">
    <option>選択してください</option>
  </select>  

  <script type="text/javascript" src="http://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js"></script>
  <script src="/socket.io/socket.io.js"></script>

   <!-- midi.js package -->
   <script src="./midijs/js/MIDI/AudioDetect.js" type="text/javascript"></script>
   <script src="./midijs/js/MIDI/LoadPlugin.js" type="text/javascript"></script>
   <script src="./midijs/js/MIDI/Plugin.js" type="text/javascript"></script>
   <script src="./midijs/js/MIDI/Player.js" type="text/javascript"></script>
   <script src="./midijs/js/Window/DOMLoader.XMLHttp.js" type="text/javascript"></script>
   <script src="./midijs/js/Window/DOMLoader.script.js" type="text/javascript"></script>
   <!-- extras -->
   <script src="./midijs/inc/Base64.js" type="text/javascript"></script>
   <script src="./midijs/inc/base64binary.js" type="text/javascript"></script>
  <script type="text/javascript">

  </script>

  <script type="text/javascript">

    var _output = null;

    //  var s = io.connect(); //リモート
    var s = io.connect('http://172.19.133.29:3000'); //ローカル

    MIDI.loadPlugin({
      soundfontUrl: "./midijs/soundfont/",
      instrument: "acoustic_grand_piano",
      callback: function() {
        // var delay = 0; // play one note every quarter second
        // var note = 50; // the MIDI note
        // var velocity = 127; // how hard the note hits
        // // play the note
        // MIDI.setVolume(0, 127);
        // MIDI.noteOn(0, note, velocity, delay);
        // MIDI.noteOff(0, note, delay + 0.75);        
      }
    });

    //サーバから受け取るイベント
    s.on("connect", function () {});  // 接続時
    s.on("disconnect", function (client) {});  // 切断時
    s.on("S_to_C_message", function (data) {
      addMessage(data.value);

      try {
        var o =  JSON.parse(data.value);
      } catch (e){
        return
      }
      var midiMessage = [];
      for( i in o ) {
       midiMessage[i] = o[i];
      }
      var delay = 0;
      MIDI.setVolume(0, 127);
      MIDI.noteOn(0, midiMessage[1], midiMessage[2], delay);
      // MIDI.noteOff(0, midiMessage[1], delay + 0.75);

      if (! _output) return;
      var buffer = new Uint8Array(midiMessage);
      _output.send(buffer);
    });

    //クライアントからイベント送信（イベント名は自由に設定できます）
    function sendMessage() {
      var msg = $("#message").val(); //取得
      $("#message").val(""); //空白にする
      s.emit("C_to_S_message", {value:msg}); //サーバへ送信
    }

    function sendBroadcast() {
      var msg = $("#message").val(); //取得
      $("#message").val(""); //空白にする
      s.emit("C_to_S_broadcast", {value:msg}); // サーバへ送信
    }

    //jqueryでメッセージを追加
    function addMessage (value,color,size) {
      var msg = value.replace( /[!@$%<>'"&|]/g, '' ); //タグ記号とかいくつか削除
      $("#msg_list").prepend("<div class='msg'>" + msg + "</div>");
    }

    (function() {
      var midi = null;
      var inputs = null;
      var outputs = null;

      try {
        navigator.requestMIDIAccess().then( onMIDISuccess, onMIDIFailure);
      } catch (e) {
        $("#info").append("<p>お使いのブラウザはWEB MIDI APIに対応していません。WEB MIDI APIを実装したブラウザでご覧ください。<br/>Google Chrome Mac版を利用ください。</p>");
        console.log(e);
      }
      function onMIDISuccess(midiAccess) {
        console.log( "MIDI ready!" );
        midi = midiAccess;

        inputs = midi.inputs();
        outputs = midi.outputs();
        console.log(outputs)
        for( var i = 0; i < inputs.length; i++) {
          $("#midi_in").append('<option value="'+ i +'">' + inputs[i]["name"]  + '</option>');
        }
        for( var i = 0; i < outputs.length; i++) {
          $("#midi_out").append('<option value="'+ i +'">' + outputs[i]["name"]  + '</option>');
        }
      }
      function onMIDIFailure(msg) {
        console.log( "Failed to get MIDI access - " + msg );
      }
      $("#midi_in").on("change", function() {
        var port = $("#midi_in option:selected").val();
        console.log(port);
        inputs[port].onmidimessage = onMIDIMessage;
      });
      $("#midi_out").on("change", function() {
        var port = $("#midi_out option:selected").val();
        _output = outputs[port];
      });
      function onMIDIMessage( event ) {
        console.log(event);
        var str = "MIDI message received [" + event.data.length + " bytes]: ";
        for (var i=0; i<event.data.length; i++) {
            str += "0x" + event.data[i].toString(16) + " " ;
        }
        console.log(str);
        // s.emit("C_to_S_broadcast", {value:str});
        // s.emit("C_to_S_broadcast", {value:JSON.stringify(event.data)});
        s.emit("C_to_S_message", {value:JSON.stringify(event.data)});
      }      

    })();
  </script>

</body>
</html>